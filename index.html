<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Service Report Form</title>
  <style>
    body {
      font-family:"Segoe UI",Arial,Helvetica,sans-serif;
      margin:0;padding:10px;
      background:#eef2f7;color:#111;
    }
    .container {
      max-width:900px;margin:0 auto;
      background:#fff;border-radius:10px;
      padding:20px;
      box-shadow:0 4px 14px rgba(0,0,0,0.12);
    }
    header { text-align:center;margin-bottom:12px; }
    header h1 {
      margin:0;font-size:20px;
      font-weight:600;color:#fff;
      background:#0b5ed7;padding:6px;border-radius:6px 6px 0 0;
    }
    header h2 {
      margin:0;font-size:14px;color:#fff;
      background:#0b5ed7;padding:4px;border-radius:0 0 6px 6px;
    }
    .formNo {
      margin-top:6px;font-size:12px;
      font-weight:bold;
      text-align:center;
      padding-bottom:6px;
      border-bottom:2px solid #0b5ed7;
    }
    /* main form box */
    .formBox {
      border:2px solid #0b5ed7;
      border-radius:8px;
      padding:12px;
      margin-top:12px;
    }
    .section {
      margin:12px 0;
      padding:10px;
      border:1px solid #ccc;
      border-radius:6px;
      background:#fafafa;
    }
    .section h3 {
      margin:0 0 8px;font-size:14px;
      color:#fff;
      background:#0b5ed7;
      padding:4px;
      border-radius:4px;
    }
    .row { display:flex;flex-wrap:wrap;gap:12px }
    .col { flex:1;min-width:180px }
    label { display:block;font-size:12px;margin-bottom:4px;color:#333 }
    input,textarea {
      width:100%;padding:6px;font-size:13px;
      border:1px solid #bbb;border-radius:4px
    }
    textarea { resize:vertical;min-height:60px }
    .sig {
      border:1px solid #999;border-radius:4px;
      height:80px;background:#fff
    }
    .sig-controls { margin-top:6px }
    .controls {
      margin:15px 0;display:flex;gap:10px;flex-wrap:wrap
    }
    button {
      padding:8px 14px;border:none;border-radius:5px;
      background:#0b5ed7;color:#fff;font-size:13px;cursor:pointer
    }
    button.secondary { background:#555 }
    /* Preview area styled like form */
    #previewArea {
      width:210mm;min-height:297mm;
      margin:0 auto;padding:12mm;box-sizing:border-box;
      border:1px solid #ddd;background:#fff;
    }
    #previewArea h1 {
      font-size:16px;margin:0;text-align:center;color:#fff;
      background:#0b5ed7;padding:6px;border-radius:6px 6px 0 0;
    }
    #previewArea h2 {
      font-size:13px;margin:0;text-align:center;color:#fff;
      background:#0b5ed7;padding:4px;border-radius:0 0 6px 6px;
    }
    #previewArea .formNo {
      margin:6px 0 12px;text-align:center;
      font-size:12px;font-weight:bold;
      border-bottom:2px solid #0b5ed7;padding-bottom:4px;
    }
    #previewArea .formBox { border:2px solid #0b5ed7;padding:10px;border-radius:8px }
    #previewArea .section { margin:12px 0; padding:10px; border:1px solid #ccc; border-radius:6px; background:#fafafa; }
    #previewArea h3 {
      font-size:13px;margin-top:8px;margin-bottom:4px;
      color:#fff;background:#0b5ed7;padding:4px;border-radius:4px;
    }
    #previewArea p { font-size:12px;margin:2px 0 }
    img.sig-img { border:1px solid #000; margin-top:4px }
    @media(max-width:700px){ #previewArea{width:100%;min-height:auto;} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Jagannath Gupta Institute Of Medical Science & Hospital. North - Kolkata</h1>
      <h2>Biomedical Equipment Maintenance Cum Breakdown Service Report</h2>
      <div class="formNo">Form No: <span id="formNo"></span></div>
    </header>

    <!-- FORM -->
    <form id="serviceForm" onsubmit="return false;">
      <div class="formBox">
        <div class="section">
          <h3>Complaint Information</h3>
          <div class="row">
            <div class="col"><label>Date</label><input type="date" id="complaintDate"/></div>
            <div class="col"><label>Time</label><input type="time" id="complaintTime"/></div>
            <div class="col"><label>Department</label><input type="text" id="department"/></div>
          </div>
        </div>

        <div class="section">
          <h3>Equipment Details</h3>
          <div class="row">
            <div class="col"><label>Equipment</label><input type="text" id="equipment"/></div>
            <div class="col"><label>Model</label><input type="text" id="model"/></div>
            <div class="col"><label>Make</label><input type="text" id="make"/></div>
            <div class="col"><label>Serial No</label><input type="text" id="serial"/></div>
          </div>
        </div>

        <div class="section">
          <h3>Problem & Resolution</h3>
          <div class="row">
            <div class="col"><label>Problem Reported</label><textarea id="problem"></textarea></div>
            <div class="col"><label>Action Taken</label><textarea id="action"></textarea></div>
          </div>
        </div>

        <div class="section">
          <h3>Completion Details</h3>
          <div class="row">
            <div class="col"><label>Finish Date</label><input type="date" id="finishDate" onchange="calcDowntime()"/></div>
            <div class="col"><label>Finish Time</label><input type="time" id="finishTime" onchange="calcDowntime()"/></div>
            <div class="col"><label>Downtime</label><input type="text" id="downtime" readonly/></div>
          </div>
          <div class="row">
            <div class="col"><label>Repaired by</label><input type="text" id="repairedBy"/></div>
            <div class="col"><label>Spare Parts Used</label><input type="text" id="spares"/></div>
            <div class="col"><label>Cause of Failure</label><input type="text" id="cause"/></div>
          </div>
        </div>

        <div class="section">
          <h3>User Department</h3>
          <div class="row">
            <div class="col"><label>Name</label><input type="text" id="userDept"/></div>
            <div class="col"><label>Emp Code</label><input type="text" id="userCode"/></div>
            <div class="col">
              <label>Signature</label>
              <canvas id="userSig" class="sig" width="250" height="80"></canvas>
              <div class="sig-controls">
                <button type="button" class="secondary" onclick="userPad.clear()">Clear</button>
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>Engineer</h3>
          <div class="row">
            <div class="col"><label>Name</label><input type="text" id="engName"/></div>
            <div class="col"><label>Code</label><input type="text" id="engCode"/></div>
            <div class="col">
              <label>Signature</label>
              <canvas id="engSig" class="sig" width="250" height="80"></canvas>
              <div class="sig-controls">
                <button type="button" class="secondary" onclick="engPad.clear()">Clear</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="controls">
        <button type="button" onclick="renderPreview()">Preview</button>
        <button type="button" onclick="downloadPDF()">Download PDF</button>
        <button type="button" class="secondary" onclick="location.reload()">Reset</button>
      </div>
    </form>

    <div>
      <h3>Preview (A4 size)</h3>
      <div id="previewArea"></div>
    </div>
  </div>

  <!-- LIBS -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Auto Form Number
    document.getElementById("formNo").innerText = "JIMSH-NK-" + Date.now();

    // Signature pads
    const userPad = new SignaturePad(document.getElementById("userSig"));
    const engPad = new SignaturePad(document.getElementById("engSig"));

    // Auto downtime calculation
    function calcDowntime(){
      const startDate = complaintDate.value;
      const startTime = complaintTime.value;
      const endDate = finishDate.value;
      const endTime = finishTime.value;
      if(startDate && startTime && endDate && endTime){
        const start = new Date(startDate+"T"+startTime);
        const end = new Date(endDate+"T"+endTime);
        if(end > start){
          let diffMs = end - start;
          let hours = Math.floor(diffMs/1000/60/60);
          let mins = Math.floor((diffMs/1000/60) % 60);
          downtime.value = hours+"h "+mins+"m";
        }
      }
    }

    // Render preview exactly like form
    function renderPreview(){
      const prev = document.getElementById("previewArea");
      prev.innerHTML = `
        <h1>Jagannath Gupta Institute Of Medical Science & Hospital. North - Kolkata</h1>
        <h2>Biomedical Equipment Maintenance Cum Breakdown Service Report</h2>
        <div class="formNo">Form No: ${formNo.innerText}</div>
        <div class="formBox">

          <div class="section">
            <h3>Complaint Information</h3>
            <p><b>Date:</b> ${complaintDate.value}</p>
            <p><b>Time:</b> ${complaintTime.value}</p>
            <p><b>Department:</b> ${department.value}</p>
          </div>

          <div class="section">
            <h3>Equipment Details</h3>
            <p><b>Equipment:</b> ${equipment.value}</p>
            <p><b>Model:</b> ${model.value}</p>
            <p><b>Make:</b> ${make.value}</p>
            <p><b>Serial No:</b> ${serial.value}</p>
          </div>

          <div class="section">
            <h3>Problem & Resolution</h3>
            <p><b>Problem Reported:</b> ${problem.value}</p>
            <p><b>Action Taken:</b> ${action.value}</p>
          </div>

          <div class="section">
            <h3>Completion Details</h3>
            <p><b>Finish Date:</b> ${finishDate.value}</p>
            <p><b>Finish Time:</b> ${finishTime.value}</p>
            <p><b>Downtime:</b> ${downtime.value}</p>
            <p><b>Repaired by:</b> ${repairedBy.value}</p>
            <p><b>Spare Parts Used:</b> ${spares.value}</p>
            <p><b>Cause of Failure:</b> ${cause.value}</p>
          </div>

          <div class="section">
            <h3>User Department</h3>
            <p><b>Name:</b> ${userDept.value}</p>
            <p><b>Emp Code:</b> ${userCode.value}</p>
            ${!userPad.isEmpty()?'<img class="sig-img" src="'+userPad.toDataURL()+'" width="150"/>':'<i>No Signature</i>'}
          </div>

          <div class="section">
            <h3>Engineer</h3>
            <p><b>Name:</b> ${engName.value}</p>
            <p><b>Code:</b> ${engCode.value}</p>
            ${!engPad.isEmpty()?'<img class="sig-img" src="'+engPad.toDataURL()+'" width="150"/>':'<i>No Signature</i>'}
          </div>

        </div>
      `;
      return prev;
    }

    // Download PDF with multipage support
    async function downloadPDF(){
      const preview = renderPreview();
      await new Promise(r=>setTimeout(r,200));
      const canvas = await html2canvas(preview,{scale:2});
      const imgData = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p","mm","a4");
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgProps = pdf.getImageProperties(imgData);
      const imgHeight = (imgProps.height * pageWidth) / imgProps.width;

      let heightLeft = imgHeight;
      let position = 0;

      while (heightLeft > 0) {
        pdf.addImage(imgData,"PNG",0,position,pageWidth,imgHeight);
        heightLeft -= pageHeight;
        position -= pageHeight;
        if(heightLeft > 0){ pdf.addPage(); }
      }
      pdf.save(formNo.innerText+".pdf");
    }
  </script>
</body>
</html>
